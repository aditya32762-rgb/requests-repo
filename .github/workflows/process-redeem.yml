name: Process redeem issue

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  redeem:
    runs-on: ubuntu-latest
    steps:
      - name: Parse issue body (username/hwid/code)
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || "";
            const lines = body.split(/\r?\n/);
            function findVal(prefix) {
              const ln = lines.find(l => l.toLowerCase().startsWith(prefix + ":"));
              return ln ? ln.split(":").slice(1).join(":").trim() : "";
            }
            const username = findVal("username");
            const hwid = findVal("hwid");
            const code = findVal("code");
            if (!username || !hwid || !code) {
              await github.issues.createComment({
                ...context.repo,
                issue_number: issue.number,
                body: "Invalid request format. Please include lines exactly like:\n```\nusername: yourname\nhwid: YOUR-HWID-STRING\ncode: REDEEM-CODE\n```"
              });
              throw new Error("Invalid request format");
            }
            core.setOutput("username", username);
            core.setOutput("hwid", hwid);
            core.setOutput("code", code);
            core.setOutput("issue_number", String(issue.number));

      - name: Checkout codes-repo (read)
        uses: actions/checkout@v4
        with:
          repository: aditya32762-rgb/codes-repo
          token: ${{ secrets.CODES_REPO_READ_TOKEN }}
          path: codes-repo

      - name: Checkout users-repo (write)
        uses: actions/checkout@v4
        with:
          repository: aditya32762-rgb/users-repo
          token: ${{ secrets.WRITE_TOKEN_USERS_REPO }}
          path: users-repo

      - name: Validate code & add user (python)
        env:
          USERNAME: ${{ steps.parse.outputs.username }}
          HWID: ${{ steps.parse.outputs.hwid }}
          CODE: ${{ steps.parse.outputs.code }}
          ISSUE_NUMBER: ${{ steps.parse.outputs.issue_number }}
        run: |
          python3 - <<'PY'
import os, json, hashlib, datetime, sys
from pathlib import Path

username = os.environ.get("USERNAME","").strip()
hwid = os.environ.get("HWID","").strip()
code = os.environ.get("CODE","").strip()
issue_no = os.environ.get("ISSUE_NUMBER","").strip()

if not username or not hwid or not code:
    print("Missing inputs")
    sys.exit(2)

codes_path = Path("codes-repo/active_codes.json")
if not codes_path.exists():
    print("active_codes.json missing")
    sys.exit(3)
codes = json.load(open(codes_path, "r", encoding="utf-8"))

found = None
for c in codes.get("codes", []):
    if c.get("code","").strip().upper() == code.strip().upper():
        found = c
        break
if not found:
    print("Code not found")
    sys.exit(4)
if found.get("used", False):
    print("Code already used")
    sys.exit(5)

users_path = Path("users-repo/users.json")
data = {"users": [], "expired_users": []}
if users_path.exists():
    data = json.load(open(users_path, "r", encoding="utf-8"))

for u in data.get("users", []):
    if u.get("code","").strip().upper() == code.strip().upper():
        print("Code already assigned in users.json")
        sys.exit(6)

now = datetime.datetime.utcnow().replace(tzinfo=datetime.timezone.utc)
duration = int(found.get("durationDays", 30))
expiry = (now + datetime.timedelta(days=duration)).isoformat()
hwid_hash = hashlib.sha256(hwid.encode('utf-8')).hexdigest()

user = {
  "username": username,
  "passwordHash": "",
  "hwidHash": hwid_hash,
  "code": found.get("code"),
  "activatedUtc": now.isoformat(),
  "expiryUtc": expiry,
  "revoked": False
}
data["users"].append(user)

# mark code used
for c in codes["codes"]:
    if c.get("code","").strip().upper() == code.strip().upper():
        c["used"] = True

open(users_path, "w", encoding="utf-8").write(json.dumps(data, indent=2, ensure_ascii=False))
open(codes_path, "w", encoding="utf-8").write(json.dumps(codes, indent=2, ensure_ascii=False))
print(f"Added user {username} (issue #{issue_no})")
PY

      - name: Commit & push changes
        env:
          ISSUE_NUMBER: ${{ steps.parse.outputs.issue_number }}
        run: |
          cd users-repo || exit 1
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add users.json || true
          git commit -m "Add user from redeem issue #$ISSUE_NUMBER" || echo "no changes to commit"
          git push || echo "push failed"
          cd ..
          cd codes-repo || exit 1
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add active_codes.json || true
          git commit -m "Mark code used from redeem issue #$ISSUE_NUMBER" || echo "no changes to commit"
          git push || echo "push failed"
