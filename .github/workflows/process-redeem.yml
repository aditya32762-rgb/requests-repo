name: Process redeem issue

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  redeem:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout codes-repo (read)
        uses: actions/checkout@v4
        with:
          repository: aditya32762-rgb/codes-repo
          token: ${{ secrets.CODES_REPO_READ_TOKEN }}
          path: codes-repo

      - name: Checkout users-repo (write)
        uses: actions/checkout@v4
        with:
          repository: aditya32762-rgb/users-repo
          token: ${{ secrets.WRITE_TOKEN_USERS_REPO }}
          path: users-repo

      - name: Validate issue and update JSONs
        run: |
          python3 - <<'PY'
import os, json, hashlib, datetime, sys
from pathlib import Path

evt_path = os.environ.get("GITHUB_EVENT_PATH")
if not evt_path or not Path(evt_path).exists():
    print("GITHUB_EVENT_PATH not set or file missing:", evt_path)
    sys.exit(2)

try:
    evt = json.load(open(evt_path, "r", encoding="utf-8"))
except Exception as e:
    print("Failed to read event JSON:", e)
    sys.exit(3)

issue = evt.get("issue", {}) or {}
body = issue.get("body", "") or ""
lines = [l.strip() for l in body.splitlines() if l.strip()]

def find_val(prefix):
    for l in lines:
        if l.lower().startswith(prefix + ":"):
            return l.split(":",1)[1].strip()
    return ""

username = find_val("username")
hwid = find_val("hwid")
code = find_val("code")

if not (username and hwid and code):
    print("Invalid issue format. Expected lines: username:, hwid:, code:")
    print("Issue body was:\\n", body)
    sys.exit(4)

codes_path = Path("codes-repo/active_codes.json")
if not codes_path.exists():
    print("Missing codes file at", codes_path)
    sys.exit(5)

codes = json.load(open(codes_path, "r", encoding="utf-8"))

found = None
for c in codes.get("codes", []):
    if c.get("code","").strip().upper() == code.strip().upper():
        found = c
        break
if not found:
    print("Code not found:", code)
    sys.exit(6)
if found.get("used", False):
    print("Code already used:", code)
    sys.exit(7)

users_path = Path("users-repo/users.json")
data = {"users": [], "expired_users": []}
if users_path.exists():
    data = json.load(open(users_path, "r", encoding="utf-8"))

for u in data.get("users", []):
    if u.get("code","").strip().upper() == code.strip().upper():
        print("Code already assigned in users.json")
        sys.exit(8)

now = datetime.datetime.utcnow().replace(tzinfo=datetime.timezone.utc)
duration = int(found.get("durationDays", 30))
expiry = (now + datetime.timedelta(days=duration)).isoformat()
hwid_hash = hashlib.sha256(hwid.encode('utf-8')).hexdigest()
user = {
  "username": username,
  "passwordHash": "",
  "hwidHash": hwid_hash,
  "code": found.get("code"),
  "activatedUtc": now.isoformat(),
  "expiryUtc": expiry,
  "revoked": False
}
data["users"].append(user)

for c in codes["codes"]:
    if c.get("code","").strip().upper() == code.strip().upper():
        c["used"] = True

open(users_path, "w", encoding="utf-8").write(json.dumps(data, indent=2, ensure_ascii=False))
open(codes_path, "w", encoding="utf-8").write(json.dumps(codes, indent=2, ensure_ascii=False))

print("User added:", username)
PY

      - name: Commit users.json
        run: |
          cd users-repo || exit 1
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add users.json || true
          if git commit -m "Add user from redeem issue" ; then
            git push || echo "push failed"
          else
            echo "No changes to commit in users-repo"
          fi

      - name: Commit active_codes.json
        run: |
          cd codes-repo || exit 1
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add active_codes.json || true
          if git commit -m "Mark code used from redeem" ; then
            git push || echo "push failed"
          else
            echo "No changes to commit in codes-repo"
          fi
